name: Run Format, Unit Tests, and Integration Tests

on: [pull_request]

jobs:
  gofmt: 
    name: "Go Format Check"
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Check code formatting using gofmt
      uses: Jerome1337/gofmt-action@v1.0.5
      with:
          gofmt-path: '.'
          gofmt-flags: '-l -d'

  clang-format:
    name: "Clang Format Protobuf Check"
    runs-on: ubuntu-latest
    needs: [gofmt]

    steps:
    - uses: actions/checkout@v4
    - name: Run clang-format style check for C/C++/Protobuf programs.
      uses: jidicula/clang-format-action@v4.13.0
      with:
        clang-format-version: '17'
        include-regex: '^.*\.proto$'

  staticcheck-linter:
    name: "Go staticcheck Lint Tool"
    runs-on : ubuntu-latest
    needs: [clang-format]
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-go@v5
      with:
        go-version: 1.22.x
    -name: "Install staticcheck"
      run: go install honnef.co/go/tools/cmd/staticcheck@latest
    - name: Run staticcheck linter
      run: bash -c 'staticcheck ./... | grep -E -v "(.*\.pb\.go|.*\.pb\.gw\.go|.*\.pulsar\.go)" && exit 1 || exit 0'

  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-go@v5
      with:
        go-version: 1.22.x

    - name: Test
      uses: robherley/go-test-action@v0.4.1

  integration-test:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-go@v5
      with:
        go-version: 1.22.x

    - name: Apply Invariants Patch
      run: git apply ./test/invariant/invariants.patch

    - name: Run allora l1 chain
      run: bash ./test/local_testnet_l1.sh

    - name: IntegrationTest
      run: INTEGRATION=TRUE RPC_MODE="RoundRobin" RPC_URLS="http://localhost:26657,http://localhost:26658,http://localhost:26659" /usr/bin/go test -timeout 15m -run ^TestExternalTestSuite$ github.com/allora-network/allora-chain/test/integration -v

